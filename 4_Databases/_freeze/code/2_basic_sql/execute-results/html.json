{
  "hash": "56d0bcdd4ba2539043fc6844b3ebfb16",
  "result": {
    "markdown": "# Basic SQL\n\n## Terminology\n\n- Database: contains many tables\n- Relation or table: contains tuples and attributes\n- Tuple or row: a set of fields that generally represents an \"object\", like a person or a music track\n- Attribute also column or field: one of possibly many elements of data corresponding to the object represented by the row\n\n\n## Relational databases\n\nRelational databases model data by storing rows and columns in tables. The power of the relational database lies in its ability to effectively retrieve data from these tables and in particular where there are multiple tables and relationships between those tables involved in the query.  \n\n\n## SQL\n\n- Stands for \"Structured Query Language\", the language we use to issue commands to a database:\n    - Create a table\n    - Retrieve some data\n    - Insert data\n    - Update data\n    - Delete data\n\n\n## Roles in large projects\n\n- **Application developer**: builds the logic for the application, the look and feel of the application, monitors the application for problems\n- **Database administrator**: Monitors and adjusts the database as the programs runs in production\n- Often both people participate in the building of the \"data model\"\n\n\n## Database model\n\nA database model or database schema is the structure or format of a database, described in a formal language supported by the database management system. In other words, a \"database model\" is the application of a data model when used in conjunction with a database management system.\n\n\n## Common database systems\n\n- There are three major Database Management Systems in wide use:\n    - Oracle: Large, commercial, enterprise-scale, very tweakable\n    - MySQL: Simpler but fast and scalable, and commercial open source\n    - SqlServer: nice, from Microsoft\n- Many smaller projects that are free and open source such as HSQL, SQLite, Postgress, ...\n\nFor this tutorial we work with SQLite downloaded from: `https://sqlitebrowser.org/dl/`.\n\nWe start it using the `DB Browser for SQLite`\n\n- Start by saying: new database\n- Save as sql1 in the projects data folder\n- Now we can add data to this database. We only do this in the SQL browser, we don't use other tools for this\n\nLets start with creating a table by using the 'execute sql' tab and entering:\n\n```\nCREATE TABLE Users(\nname VARCHAR(128),\nemail VARCHAR(128)\n)\n```\n\nHere we create a table with the name user and we add two columns named name and email, each should only include characters with up to 128 characters. This is our contract, our schema.\n\nBy being very explicit about our data things become very fast.\n\nAfter we hit the execute button, we get an added table in the DB schema.  \n\nNext, lets add some data:\n\n- Go to browse data, table users\n- Click new record add 4 new rows \n- If we check the SQL log to see all commands that were run in the back\n\n\n## SQL insert\n\nThe insert statement inserts a new row into the table. Above we used the interface to accomplish this but we also can use a SQL commands:\n\n```\nINSERT INTO Users (name, email) VALUES ('Kirstin', 'kf@umich.edu')\n```\n\n\n## SQL delete\n\nDeletes a row in the table based on a selection criteria:\n\n```\nDELETE FROM Users WHERE email='fred@umich.edu'\n```\n\nWith the WHERE we say: Only delete were XYZ is true.\n\n\n## SQL update\n\nAllows us to update a field with a where clause:\n\n```\nUPDATE Users SET name='Charles' WHERE email='csev@umich.edu'\n```\n\nHere, the where clause is important, otherwise we would update ALL the names.\n\n\n## Retriving records: Select\n\nThe select statement retrieves a group of records: you can either retrieve all their records or a subset of records with a where clause:\n\n```\nSELECT * FROM Users\n```\n\n```\nSELECT * FROM Users WHERE email='csev@umich.edu'\n```\n\n\n## Sorting with ORDER BY\n\nYou can add an order by clause to select statements to get the result sorted in ascending or descending order\n\n```\nSELECT * FROM Users ORDER BY email\n```\n\n\n## Worked Example: Counting Email in a Database\n\nCode is in `code/count_sql.py`\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport sqlite3\n\n#connect to db, it will create the file if it does not exist\nconn = sqlite3.connect('../data/emaildb.sqlite')\n\n#create a database handle\n#i.e. we send commands to the cursor and get responses through that cursor\ncur = conn.cursor()\n\n#if table exist, delete so we have a fresh start\ncur.execute('DROP TABLE IF EXISTS Counts')\n\n#create a new table from fresh\ncur.execute('CREATE TABLE counts (email TEXT, count INTEGER)')\n\nfname='../data/mbox-short.txt'\nfh = open(fname)\n\nfor line in fh:\n    if not line.startswith('From: '): \n        continue\n    pieces = line.split()\n    \n    #extract email addresses\n    email = pieces[1]\n\n    #prepare the cursor to receive data:\n    #`=?` here, the ? is a placeholder to prevent sql injections\n    #the placeholder ultimately will replaced it with a ONE tuple `(email,)`\n    cur.execute('SELECT count FROM Counts WHERE email = ? ', (email,))\n    \n    #grep the first one and give it back in row\n    row = cur.fetchone()\n\n    #if the row is empty insert the mail and an inital count of 1\n    #if the row exists, i.e. the mail is already in there, update the counter    \n    if row is None:\n        cur.execute('''INSERT INTO Counts (email, count) VALUES (?,1)''', (email,))\n    else:\n        cur.execute('UPDATE Counts SET count = count + 1 WHERE email = ?',(email,))\n    \n    #write the db to disk\n    conn.commit()\n\n#create string to extract data\nsqlstr = 'SELECT email, count FROM Counts ORDER BY count DESC LIMIT 10'\n\n#extract data\nfor row in cur.execute(sqlstr):\n    print(str(row[0]), row[1])\n\nprint('')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ncwen@iupui.edu 5\nzqian@umich.edu 4\ndavid.horwitz@uct.ac.za 4\nlouis@media.berkeley.edu 3\ngsilver@umich.edu 3\nstephen.marquard@uct.ac.za 2\nrjlowe@iupui.edu 2\nwagnermr@iupui.edu 1\nantranig@caret.cam.ac.uk 1\ngopal.ramasammycook@gmail.com 1\n\n```\n:::\n:::\n\n\n## Exercise 1: Our First Database\n\nThen, create a SQLITE database or use an existing database and create a table in the database called \"Ages\":\n\n```\nCREATE TABLE Ages ( \n  name VARCHAR(128), \n  age INTEGER\n)\n```\n\nThen make sure the table is empty by deleting any rows that you previously inserted, and insert these rows and only these rows with the following commands:\n\n```\nDELETE FROM Ages;\nINSERT INTO Ages (name, age) VALUES ('Philip', 21);\nINSERT INTO Ages (name, age) VALUES ('Rydha', 18);\nINSERT INTO Ages (name, age) VALUES ('Adana', 23);\nINSERT INTO Ages (name, age) VALUES ('Oscar', 31);\nINSERT INTO Ages (name, age) VALUES ('Kayda', 30);\nINSERT INTO Ages (name, age) VALUES ('Makenna', 27);\n```\n\nOnce the inserts are done, run the following SQL command:\n\n```\nSELECT hex(name || age) AS X FROM Ages ORDER BY X\n```\n\n## Exercise 2: Count email\n\nThis application will read the mailbox data (mbox.txt) and count the number of email messages per organization (i.e. domain name of the email address) using a database with the following schema to maintain the counts.\n\n```\nCREATE TABLE Counts (org TEXT, count INTEGER)\n```\n\nCode is in `code/sql_ex1.py`\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nimport sqlite3\nimport re\n\n#connect to db, it will create the file if it does not exist\nconn = sqlite3.connect('orga_info.sqlite')\n\n#create a database handle\n#i.e. we send commands to the cursor and get responses through that cursor\ncur = conn.cursor()\n\n#if table exist, delete so we have a fresh start\ncur.execute('DROP TABLE IF EXISTS Counts')\n\n#create a new table from fresh\ncur.execute('CREATE TABLE counts (org TEXT, count INTEGER)')\n\nfname='../data/mbox.txt'\nfh = open(fname)\n\nfor line in fh:\n    if not line.startswith('From: '): \n        continue\n\n    #extract orga info\n    email = line.split()[1]\n    orga = email.split('@')[1]\n    #print((orga))\n\n    #prepare the cursor to receive data:\n    #`=?` here, the ? is a placeholder to prevent sql injections\n    #the placeholder ultimately will replaced it with a ONE tuple `(email,)`\n    cur.execute('SELECT count FROM Counts WHERE org = ? ', (orga,))\n    \n    #grep the first one and give it back in row\n    row = cur.fetchone()\n\n    #if the row is empty insert the mail and an inital count of 1\n    # if the row exists, i.e. the mail is already in there, update the counter    \n    if row is None:\n        cur.execute('''INSERT INTO Counts (org, count) VALUES (?,1)''', (orga,))\n    else:\n        cur.execute('UPDATE Counts SET count = count + 1 WHERE org = ?',(orga,))\n   \n    #write the db to disk\n    conn.commit()\n\n#create string to extract data\nsqlstr = 'SELECT org, count FROM Counts ORDER BY count DESC'\n\n#view data\n##for row in cur.execute(sqlstr):\n#    print(str(row[0]), row[1])\n\n#count data \nnum_list = list()\n\nfor row in cur.execute(sqlstr):\n    num = int(row[1])\n    num_list.append(num)\n\nprint(sum(num_list))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n1797\n```\n:::\n:::\n\n\n",
    "supporting": [
      "2_basic_sql_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}